/**
 * Created by Sam on 18/05/15.
 */
function start(port) {
    var gateConnections = {};

    var messages = require('messages');
    var WebSocketServer = require('ws').Server
        , wss = new WebSocketServer({port: port});


    console.log("New web socket server, listening on port " + port);


    wss.broadcast = function broadcast(data) {
        wss.clients.forEach(function each(client) {
            client.send(data);
        });
    };

    wss.on('error', function (a, b) {
        console.error("ERROR - ", a, b);
    });

    wss.on('connection', function connection(ws) {
        setInterval(function(){ws.send('ping', function() {

        })}, 500);
        //console.log("new client: " + ws);
        ws.on('message', function incoming(message) {

            var message = JSON.parse(message);
            switch (message.type) {
                case messages.types.HANDSHAKE:
                    registerGate(ws, message.gateID);
                    ws.send("You have connected successfully");
                    break;


            }

        });

        ws.on('close', function () {
            console.log("Gate with id " + ws.id + " got disconnected.");
            gateConnections[ws.id] = undefined;
        });


    });




    function registerGate(ws, id) {
        gateConnections[id] = ws;
        ws.id = id;
        console.log("Gate with id " + ws.id + " connected.");
    }


    function isConnected(id) {
        return !(gateConnections[id] == undefined);
    }
}

exports.start = start;